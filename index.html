<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>Finger Chooser</title>

<style>
html,body{
  margin:0;height:100%;background:#000;overflow:hidden;
  font-family:-apple-system,system-ui,sans-serif;
}
#zone{height:100%;touch-action:none}

/* fondo ganador */
#fill{
  position:fixed;inset:0;
  opacity:0;transition:.25s;
  z-index:1;pointer-events:none;
}
#fill.on{opacity:1}

/* top */
#top{
  position:fixed;top:12px;left:12px;right:12px;
  display:flex;justify-content:space-between;
  z-index:10;
}
button{
  width:76px;height:76px;border-radius:50%;
  border:none;color:#fff;font-size:34px;
}
#countBtn{background:#7fb13a}
#helpBtn{background:#ff00a8;font-size:44px}

/* texto oculto */
#hint{
  position:fixed;right:10px;bottom:10px;
  font-size:11px;color:#000;opacity:.6;
}
#state{
  position:fixed;top:18px;left:50%;
  transform:translateX(-50%);
  font-size:13px;opacity:.55;color:#000;
}

/* dots */
.dot{
  --c:#ff3b30;
  position:fixed;
  width:130px;height:130px;
  border-radius:50%;
  transform:translate(-50%,-50%);
  background:var(--c);
  z-index:5;pointer-events:none;
}
.dot::before{
  content:"";position:absolute;inset:-16px;
  border-radius:50%;
  background:conic-gradient(
    var(--c) 0 70deg,
    transparent 70deg 175deg,
    var(--c) 175deg 255deg,
    transparent 255deg
  );
  -webkit-mask:radial-gradient(circle,transparent 60%,#000 61%);
  mask:radial-gradient(circle,transparent 60%,#000 61%);
  animation:spin .65s linear infinite;
}
.dot::after{
  content:"";position:absolute;inset:-8px;
  border-radius:50%;
  background:conic-gradient(
    transparent 0 45deg,
    var(--c) 45deg 100deg,
    transparent 100deg 220deg,
    var(--c) 220deg 270deg,
    transparent 270deg
  );
  -webkit-mask:radial-gradient(circle,transparent 68%,#000 69%);
  mask:radial-gradient(circle,transparent 68%,#000 69%);
  animation:spinR .75s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes spinR{to{transform:rotate(-360deg)}}

/* ganador */
.dot.win{
  background:#000;
}
.dot.win::before,
.dot.win::after{animation:none}
.dot.win::after{
  inset:0;
  background:none;
  box-shadow:
    inset 0 0 0 10px var(--c),
    inset 0 0 0 18px #000;
}
</style>
</head>

<body>
<div id="fill"></div>

<div id="top">
  <button id="countBtn">1F</button>
  <button id="helpBtn">?</button>
</div>

<div id="state">esperando</div>
<div id="hint">8 gana · W pierde · 7 gana · 9 pierde</div>

<div id="zone"></div>

<script>
const zone=document.getElementById("zone");
const fill=document.getElementById("fill");
const stateEl=document.getElementById("state");

const COLORS=["#ff3b30","#ff9500","#ffcc00","#34c759","#007aff","#5856d6"];

let fingers=new Map(),dots=new Map();
let state="waiting",timer=null;

/* ===== RESET DURO ===== */
function reset(){
  clearTimeout(timer);
  fingers.clear();
  dots.forEach(d=>d.remove());
  dots.clear();
  fill.classList.remove("on");
  state="waiting";
  stateEl.textContent="esperando";
}

/* ===== DOT ===== */
function dot(id){
  if(dots.has(id))return dots.get(id);
  const d=document.createElement("div");
  d.className="dot";
  document.body.appendChild(d);
  dots.set(id,d);
  return d;
}

/* ===== TRUCOS SUAVES ===== */
function isEight(path){
  if(path.length<8)return false;
  let minX=1e9,maxX=-1e9,minY=1e9,maxY=-1e9;
  path.forEach(p=>{
    minX=Math.min(minX,p.x);maxX=Math.max(maxX,p.x);
    minY=Math.min(minY,p.y);maxY=Math.max(maxY,p.y);
  });
  if(Math.max(maxX-minX,maxY-minY)<40)return false;

  let turns=0;
  for(let i=2;i<path.length;i++){
    const a=path[i-2].y-path[i-1].y;
    const b=path[i-1].y-path[i].y;
    if(a*b<0)turns++;
  }
  return turns>=3;   // ⬅️ muy permisivo
}

function isW(path){
  if(path.length<6)return false;
  let changes=0;
  for(let i=2;i<path.length;i++){
    const a=path[i-2].y-path[i-1].y;
    const b=path[i-1].y-path[i].y;
    if(a*b<0)changes++;
  }
  return changes>=2; // ⬅️ muy permisivo
}

/* ===== RONDA ===== */
function start(){
  if(fingers.size<2)return;
  state="running";
  stateEl.textContent="jugando";
  timer=setTimeout(end,4000);
}

function end(){
  const arr=[...fingers.entries()];

  const eight=arr.filter(([_,f])=>f.eight).map(([id])=>id);
  const banned=arr.filter(([_,f])=>f.w).map(([id])=>id);

  let winId;
  if(eight.length) winId=eight[Math.floor(Math.random()*eight.length)];
  else{
    const pool=arr.map(([id])=>id).filter(id=>!banned.includes(id));
    winId=pool[Math.floor(Math.random()*pool.length)];
  }

  const win=fingers.get(winId);
  fill.style.background=win.color;
  fill.classList.add("on");

  fingers.forEach((_,id)=>{
    if(id!==winId){
      dots.get(id)?.remove();
      dots.delete(id);
    }
  });

  const d=dot(winId);
  d.classList.add("win");

  timer=setTimeout(reset,5000);
}

/* ===== TOUCH ===== */
zone.addEventListener("touchstart",e=>{
  e.preventDefault();
  if(state!=="waiting"&&state!=="running")return;

  for(const t of e.changedTouches){
    if(!fingers.has(t.identifier)){
      fingers.set(t.identifier,{
        x:t.clientX,y:t.clientY,
        color:COLORS[fingers.size%COLORS.length],
        path:[],eight:false,w:false
      });
    }
  }
  if(state==="waiting"&&fingers.size>=2)start();
});

zone.addEventListener("touchmove",e=>{
  if(state!=="running")return;
  for(const t of e.changedTouches){
    const f=fingers.get(t.identifier);
    if(!f)return;
    f.x=t.clientX;f.y=t.clientY;
    f.path.push({x:f.x,y:f.y});
    if(!f.eight&&!f.w){
      if(isEight(f.path))f.eight=true;
      else if(isW(f.path))f.w=true;
    }
    const d=dot(t.identifier);
    d.style.left=f.x+"px";
    d.style.top=f.y+"px";
    d.style.setProperty("--c",f.color);
  }
});
</script>
</body>
</html>
