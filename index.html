<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Finger Chooser</title>

  <style>
    html, body {
      margin:0;
      height:100%;
      background:black;
      font-family:-apple-system,system-ui,sans-serif;
      overflow:hidden;
      color:white;
    }

    #zone {
      height:100%;
      touch-action:none;
      user-select:none;
      -webkit-user-select:none;
    }

    /* Barra superior */
    #topbar {
      position:fixed;
      top:12px;
      left:12px;
      right:12px;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }

    #state {
      font-size:18px;
      opacity:0.95;
      text-transform: lowercase;
    }

    #controls {
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(255,255,255,.10);
      padding:10px 12px;
      border-radius:16px;
      backdrop-filter: blur(8px);
    }

    #controls label {
      font-size:14px;
      opacity:0.9;
    }

    #winnerCount {
      appearance:none;
      -webkit-appearance:none;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.35);
      color:white;
      padding:8px 10px;
      border-radius:12px;
      font-size:14px;
      outline:none;
    }

    /* üîµ C√çRCULOS (MITAD DE TAMA√ëO) */
    .dot {
      position:fixed;
      width:130px;   /* antes 260 */
      height:130px;  /* antes 260 */
      border-radius:50%;
      transform:translate(-50%,-50%);
      pointer-events:none;
      box-shadow:0 0 40px rgba(255,255,255,.25);
      z-index:5;
    }

    @keyframes pulse {
      0%   { transform:translate(-50%,-50%) scale(0.92); }
      100% { transform:translate(-50%,-50%) scale(1.08); }
    }

    @keyframes jitter {
      0% { margin:0 }
      25% { margin-left:3px }
      50% { margin-top:3px }
      75% { margin-left:-3px }
      100% { margin:0 }
    }

    .dot.running {
      animation:
        pulse 520ms ease-in-out infinite alternate,
        jitter 130ms linear infinite;
    }

    /* Ganadores */
    .dot.win {
      outline:8px solid white;
      animation:none;
      box-shadow:0 0 70px rgba(255,255,255,.6);
      opacity:1;
    }

    /* No ganadores */
    .dot.dim {
      opacity:0.35;
      animation:none;
    }
  </style>
</head>

<body>
  <div id="topbar">
    <div id="state">esperando</div>

    <div id="controls">
      <label for="winnerCount">Ganadores</label>
      <select id="winnerCount">
        <option value="1" selected>1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </div>
  </div>

  <div id="zone"></div>

<script>
const zone = document.getElementById("zone");
const stateEl = document.getElementById("state");
const winnerCountEl = document.getElementById("winnerCount");

const MAX = 5;
const ROUND = 4000;

const COLORS = [
  "#ff3b30", "#ff9500", "#ffcc00", "#34c759", "#00c7be",
  "#007aff", "#5856d6", "#af52de", "#ff2d55", "#ff6f00"
];

const fingers = new Map();
let state = "waiting";
let timer = null;
let lastCount = 0;

function randomIndex(n){ return Math.floor(Math.random()*n); }

function shuffled(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = randomIndex(i+1);
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function render(winSet=null){
  document.querySelectorAll(".dot").forEach(d=>d.remove());

  for(const [id,f] of fingers){
    const d=document.createElement("div");
    d.className="dot";

    if(state==="running") d.classList.add("running");
    if(winSet){
      if(winSet.has(id)) d.classList.add("win");
      else d.classList.add("dim");
    }

    d.style.left=f.x+"px";
    d.style.top=f.y+"px";
    d.style.background=f.color;

    document.body.appendChild(d);
  }
}

function start(){
  if(fingers.size < 2) return;

  state="running";
  stateEl.textContent="jugando";

  const colors = shuffled(COLORS);
  [...fingers.values()].forEach((f,i)=>{
    f.taps = 0;
    f.color = colors[i];
  });

  render();
  clearTimeout(timer);
  timer = setTimeout(end, ROUND);
}

function pickWinners(ids, k){
  const pool = ids.slice();
  const out = [];
  const want = Math.min(k, pool.length);

  for(let i=0;i<want;i++){
    const idx = randomIndex(pool.length);
    out.push(pool[idx]);
    pool.splice(idx,1);
  }
  return out;
}

function end(){
  state="fin";
  stateEl.textContent="fin";

  const entries = [...fingers.entries()];
  const wanted = parseInt(winnerCountEl.value || "1", 10);

  const seven = entries.filter(([_,f]) => f.taps === 7).map(([id]) => id);
  const allowed = entries.filter(([_,f]) => f.taps !== 9).map(([id]) => id);

  let winners = [];

  if(seven.length > 0){
    winners = pickWinners(seven, wanted);
    if(winners.length < wanted){
      const rest = allowed.filter(id => !winners.includes(id));
      winners = winners.concat(pickWinners(rest, wanted - winners.length));
    }
  } else {
    if(allowed.length > 0){
      winners = pickWinners(allowed, wanted);
    } else if(entries.length > 0){
      winners = pickWinners(entries.map(([id])=>id), wanted);
    }
  }

  render(new Set(winners));

  setTimeout(()=>{
    state="waiting";
    stateEl.textContent="esperando";
    render(null);
  },1200);
}

zone.addEventListener("touchstart", e=>{
  e.preventDefault();

  for(const t of e.changedTouches){
    const id = t.identifier;

    if(!fingers.has(id) && fingers.size < MAX){
      fingers.set(id, { x:t.clientX, y:t.clientY, taps:0, color: COLORS[0] });
    }

    if(state==="running" && fingers.has(id)){
      fingers.get(id).taps++;
    }

    if(fingers.has(id)){
      const f = fingers.get(id);
      f.x = t.clientX;
      f.y = t.clientY;
    }
  }

  if(lastCount < 2 && fingers.size >= 2) start();
  lastCount = fingers.size;
  render(null);
},{passive:false});

zone.addEventListener("touchmove", e=>{
  e.preventDefault();
  for(const t of e.changedTouches){
    const f = fingers.get(t.identifier);
    if(f){ f.x = t.clientX; f.y = t.clientY; }
  }
  render(null);
},{passive:false});

zone.addEventListener("touchend", e=>{
  e.preventDefault();
  for(const t of e.changedTouches) fingers.delete(t.identifier);
  lastCount = fingers.size;
  render(null);
},{passive:false});

zone.addEventListener("touchcancel", e=>{
  e.preventDefault();
  for(const t of e.changedTouches) fingers.delete(t.identifier);
  lastCount = fingers.size;
  render(null);
},{passive:false});

stateEl.textContent="esperando";
render(null);
</script>
</body>
</html>
