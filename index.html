<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Finger Chooser</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:black;
  font-family:-apple-system,system-ui,sans-serif;
  overflow:hidden;
}
#zone{height:100%;touch-action:none}

#colorFill{
  position:fixed;inset:0;
  opacity:0;transition:.25s;
  z-index:1;pointer-events:none
}
#colorFill.on{opacity:1}

#topbar{
  position:fixed;top:12px;left:12px;right:12px;
  display:flex;justify-content:space-between;
  z-index:10
}
#state{color:white;font-size:18px}

#controls{
  background:rgba(255,255,255,.1);
  padding:10px 12px;
  border-radius:16px
}

#hint{
  position:fixed;
  right:10px;
  bottom:10px;
  font-size:11px;
  color:black;
  opacity:.6;
  z-index:20;
  user-select:none;
}

.dot{
  --c:#ff3b30;
  position:fixed;
  width:130px;height:130px;
  border-radius:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
  z-index:5;
  transition:.25s
}

/* ARO */
.dot::before{
  content:"";
  position:absolute;
  inset:-14px;
  border-radius:50%;
  background:conic-gradient(
    var(--c) 0 70deg,
    transparent 70 180deg,
    var(--c) 180 250deg,
    transparent 250 360deg
  );
  -webkit-mask:radial-gradient(circle,transparent 58%,#000 60%);
}
.dot.running::before{
  animation:spin .7s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

/* PERDEDOR */
.dot.lose{
  opacity:0;
  transform:translate(-50%,-50%) scale(.8)
}

/* GANADOR */
@keyframes pop{
  from{transform:translate(-50%,-50%) scale(1.3)}
  to{transform:translate(-50%,-50%) scale(1.05)}
}
.dot.win{
  background:#000;
  animation:pop .2s ease-out forwards
}
.dot.win::before{content:none}
.dot.win::after{
  content:"";
  position:absolute;
  inset:30px;
  border-radius:50%;
  box-shadow:
    inset 0 0 0 10px var(--c),
    inset 0 0 0 18px #000;
}
</style>
</head>

<body>
<div id="colorFill"></div>

<div id="topbar">
  <div id="state">esperando</div>
  <div id="controls">
    <select id="winnerCount">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
    </select>
  </div>
</div>

<!-- TEXTO DISCRETO -->
<div id="hint">□ gana · W pierde</div>

<div id="zone"></div>

<script>
const zone=document.getElementById("zone");
const stateEl=document.getElementById("state");
const colorFill=document.getElementById("colorFill");
const winnerCountEl=document.getElementById("winnerCount");

const COLORS=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#ff6f00"];
const MAX=5, ROUND=4000, FILL=5000;

let fingers=new Map(), dots=new Map(), timer=null, state="waiting", last=0;

const rand=n=>Math.floor(Math.random()*n);
const shuffle=a=>{a=[...a];for(let i=a.length-1;i;i--){let j=rand(i+1);[a[i],a[j]]=[a[j],a[i]]}return a};

const ensureDot=id=>{
  if(dots.has(id))return dots.get(id);
  const d=document.createElement("div");
  d.className="dot";
  document.body.appendChild(d);
  dots.set(id,d);
  return d;
};
const removeDot=id=>{
  if(dots.has(id)){dots.get(id).remove();dots.delete(id)}
};

function ensureColors(){
  const ids=[...fingers.keys()];
  const cols=shuffle(COLORS).slice(0,ids.length);
  ids.forEach((id,i)=>fingers.get(id).color=cols[i]);
}

function render(){
  for(const [id,f] of fingers){
    const d=ensureDot(id);
    d.style.left=f.x+"px";
    d.style.top=f.y+"px";
    d.style.background=f.color;
    d.style.setProperty("--c",f.color);
    d.classList.toggle("running",state==="running");
    d.classList.remove("win","lose");
  }
}

function start(){
  if(fingers.size<2)return;
  state="running";
  stateEl.textContent="jugando";
  for(const f of fingers.values()){f.taps=0;f.path=[]}
  ensureColors();
  clearTimeout(timer);
  timer=setTimeout(end,ROUND);
}

function isSquare(p){
  if(p.length<8)return false;
  let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity;
  p.forEach(pt=>{minX=Math.min(minX,pt.x);maxX=Math.max(maxX,pt.x);minY=Math.min(minY,pt.y);maxY=Math.max(maxY,pt.y)});
  const w=maxX-minX,h=maxY-minY;
  return Math.abs(w-h)<40;
}

function isW(p){
  if(p.length<8)return false;
  let changes=0;
  for(let i=2;i<p.length;i++){
    const a=p[i-2].y-p[i-1].y;
    const b=p[i-1].y-p[i].y;
    if(a*b<0)changes++;
  }
  return changes>=4;
}

function end(){
  state="fin";
  stateEl.textContent="fin";
  const want=+winnerCountEl.value;
  const entries=[...fingers.entries()];
  const squares=entries.filter(([_,f])=>isSquare(f.path)).map(([id])=>id);
  const banned=entries.filter(([_,f])=>isW(f.path)).map(([id])=>id);

  let pool=squares.length?squares:entries.map(([id])=>id).filter(id=>!banned.includes(id));
  if(!pool.length)pool=entries.map(([id])=>id);

  pool=shuffle(pool).slice(0,want);
  const win=new Set(pool);

  for(const [id] of fingers){
    const d=dots.get(id);
    d.classList.remove("running");
    d.classList.add(win.has(id)?"win":"lose");
  }

  const colors=pool.map(id=>fingers.get(id).color);
  colorFill.style.background=colors.length>1
    ?`linear-gradient(135deg,${colors.join(",")})`
    :colors[0];
  colorFill.classList.add("on");

  setTimeout(()=>{
    colorFill.classList.remove("on");
    for(const [id] of dots)if(!win.has(id))removeDot(id);
    state="waiting";
    stateEl.textContent="esperando";
    render();
  },FILL);
}

zone.addEventListener("touchstart",e=>{
  e.preventDefault();
  let ch=false;
  for(const t of e.changedTouches){
    if(!fingers.has(t.identifier)&&fingers.size<MAX){
      fingers.set(t.identifier,{x:t.clientX,y:t.clientY,taps:0,color:"#fff",path:[]});
      ch=true;
    }
    const f=fingers.get(t.identifier);
    if(f){
      f.x=t.clientX;f.y=t.clientY;
      if(state==="running")f.taps++;
    }
  }
  if(state==="waiting"&&last<2&&fingers.size>=2)start();
  if(state==="running"&&ch){clearTimeout(timer);timer=setTimeout(end,ROUND)}
  last=fingers.size;
  render();
},{passive:false});

zone.addEventListener("touchmove",e=>{
  e.preventDefault();
  if(state!=="running")return;
  for(const t of e.changedTouches){
    const f=fingers.get(t.identifier);
    if(f){f.x=t.clientX;f.y=t.clientY;f.path.push({x:f.x,y:f.y})}
  }
  render();
},{passive:false});

zone.addEventListener("touchend",e=>{
  e.preventDefault();
  let ch=false;
  for(const t of e.changedTouches){
    if(fingers.has(t.identifier)){fingers.delete(t.identifier);removeDot(t.identifier);ch=true}
  }
  last=fingers.size;
  if(state==="running"&&ch){clearTimeout(timer);timer=setTimeout(end,ROUND)}
},{passive:false});
</script>
</body>
</html>
